version: "3.9"
services:
  mongodb:
    image: mongo:4.4
    container_name: vulndb_mongodb
    ports:
      - "27018:27017"  # Puerto externo cambiado para evitar conflicto
    volumes:
      - ./services/mongodb/data:/data/db
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: changeme
    networks:
      docker_open5gs_default:
        ipv4_address: ${VULNDB_MONGO_IP}
        
  ingest:
    build:
      context: .
      dockerfile: services/ingest/Dockerfile
    container_name: vulndb_ingest
    depends_on:
      - mongodb
    env_file:
      - .env
    volumes:
      - ./services:/app/services
      - ./scripts:/app/scripts
      - ./config:/app/config
      - ./api:/app/api
    command: sleep infinity
    restart: unless-stopped
    networks:
      docker_open5gs_default:
        ipv4_address: ${VULNDB_INGEST_IP}
        
  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    container_name: vulndb_api
    ports:
      - "5000:5000"
    env_file:
      - .env
    depends_on:
      - mongodb
    volumes:
      - ./api:/app/api          
      - ./services:/app/services 
      - ./runtime:/app/runtime
    networks:
      docker_open5gs_default:
        ipv4_address: ${VULNDB_API_IP}

  ia-sandbox:
    build:
      context: .
      dockerfile: services/ia/Dockerfile
    container_name: vulndb_ia
    volumes:
      - ./services/ia:/app/ia
      - ./data:/app/data
    tty: true
    networks:
      docker_open5gs_default:
        ipv4_address: ${VULNDB_IA_IP}

  suricata:
    image: jasonish/suricata:latest
    container_name: vulndb_suricata
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ./runtime/suricata/rules:/etc/suricata/rules
      - ./runtime/suricata/logs:/var/log/suricata
    command: suricata -i br-d498833cc7cd -S /etc/suricata/rules/generated.rules -l /var/log/suricata
    restart: unless-stopped

  attacker:
    image: python:3.11
    container_name: vulndb_attacker
    volumes:
      - ./scripts:/scripts
    command: sleep infinity
    networks:
      docker_open5gs_default:
        ipv4_address: ${VULNDB_ATTACKER_IP}

networks:
  docker_open5gs_default:
    external: true